\begin{algorithm}[H]
  \caption{\rvsims{}: RVSI Protocol for Replication (for Executing Transaction $T$).}
  \label{alg:rvsims}
  \begin{algorithmic}[1]
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% For clients %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \Statex \textbf{\textit{Client-side methods:}}
    \hStatex

    \Procedure{begin}{\null}
    \State $T.\attr{sts}$ $\gets$ \algkeyword{rpc-call} \Call{start}{\null} at master 
    $\master$   \label{line:call-start}
    \EndProcedure

    \Procedure{read}{$x$}
      \State $x.\attr{ver}$ $\gets$ \algkeyword{rpc-call} \Call{read}{$x$} at any site
    \EndProcedure

    \Procedure{write}{$x, v$}
      \State add $(x, v)$ to $T.\attr{writes}$ \label{line:write-at-client}
    \EndProcedure

    \Procedure{end}{$T$}
    \State $T.\attr{vc}$ $\gets$ \Call{add-vc}{\null} \label{line:call-add-vc}
    \State $c/a$ $\gets$ \algkeyword{rpc-call} \Call{commit}{$T.\attr{writes}, 
    T.\attr{vc}$} at $\master$ \label{line:call-commit}
    \EndProcedure

    \Statex \hrulefill

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% For master %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \Statex \textbf{\textit{Master-side data structures and methods:}}
    \Statex $\master$.\attr{ts}: for start-timestamps and commit-timestamps
    \Statex $\set{x.\attr{ver} = (x.\attr{ts}, x.\attr{ord}, x.\attr{val})}$: set of versions of $x$
    \hStatex

    \Procedure{start}{\null}
    \State \Return ++$\master.\attr{ts}$
    \EndProcedure
    
    \Procedure{read}{$x$}
      \State \Return the latest $x.\attr{ver}$ installed \label{line:read-at-master}
    \EndProcedure

    \Procedure{commit}{$T.\attr{writes}, T.\attr{vc}$}
    \If{\Call{check-vc}{$T.\attr{vc}$} \&\& write-conflict freedom}   
    \label{line:call-check-vc}
      \State $T.\attr{cts}$ $\gets$ ++$\master.\attr{ts}$ 

      \lComment{apply $T.\attr{writes}$ locally and propagate it} 
      \State $T.\textrm{\it upvers} = \emptyset$  \mComment{collect updated versions}  
      \label{line:commit-updates}
      \For{$(x,v) \in T.\attr{writes}$}    
      \State $x.\attr{new-ver} \gets (T.\attr{cts}, \textrm{++}x.\attr{ord}, v)$
      \State add $x.\attr{new-ver}$ to $\set{x.\attr{ver}}$ and $T.\textrm{\it upvers}$
      \EndFor 
      \State \algkeyword{broadcast} \msg{PROP}{T.\textrm{\it upvers}} to slaves 
      \label{line:commit-prop}
      % \lendComment{apply $T.\attr{writes}$ locally and propagate it} 

      \State \Return $c$ denoting ``committed''
    \EndIf
    \State \Return $a$ denoting ``aborted''
    \EndProcedure

    \Statex \hrulefill

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% For slaves %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \Statex \textbf{\textit{Slave-side data structures and methods:}}
    \Statex $x.\attr{ver} = (x.\attr{ts}, x.\attr{ord}, x.\attr{val})$: the latest version of $x$
    \hStatex

    \Procedure{read}{$x$}
    \State \Return $x.\attr{ver}$
    \EndProcedure

    \algrenewcommand\algorithmicprocedure{\textbf{upon}}
    \Procedure{received}{\msg{PROP}{T.\textrm{\it upvers}}} \label{line:received}
    \For{$\left(x.\attr{ver}' = (x.\attr{ts}', x.\attr{ord}', x.\attr{val}')\right) \in 
    T.\textrm{\it upvers}$}
      \If{$x.\attr{ord}' > x.\attr{ord}$}  
      \State $x.\attr{ver} \gets x.\attr{ver}'$
      \EndIf
    \EndFor
    \EndProcedure
  \end{algorithmic}
\end{algorithm}
