%%%%% file: alg-rvsi-partition.tex
%%%%% description: protocol for distributed transactions across multiple partitions; using 2PC 

\begin{algorithm}[H]
  \caption{\rvsimp{}: \rvsi{} Protocol for Partition (for Executing Transaction $T$).} % (\algnamefont{RVSI-MP})}
  \label{alg:alg-rvsi-partition}
  \begin{algorithmic}[1]
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% For clients %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \Statex \textbf{\textit{Client-side methods:}}
    \hStatex

    \Procedure{begin}{\null}
	\State \Return \algkeyword{rpc-call} \Call{getTS}{\null} at $\timeoracle{}$
		\label{line:rvsimp-client-call-getts}
    \EndProcedure

	\Procedure{end}{\null}	\label{line:rvsimp-call-end}
      \State $T.\attr{vc}$ $\gets$ \Call{add-vc}{\null} \label{line:rvsimp-call-add-vc}
      \State $c/a$ $\gets$ \algkeyword{rpc-call} \Call{c-commit}{$T.\attr{writes}, T.\attr{vc}$} 
      at $\coordinator$ \label{line:rvsimp-call-commit}
    \EndProcedure

    \Statex \hrulefill
    %%%%%%%%%%%%%%%%%%%% For Timestamp Oracle %%%%%%%%%%%%%%%%%%%%
    \Statex \textbf{\textit{Timestamp oracle methods:}}
    \hStatex
	\Statex \tots{}: for start-timestamps and commit-timestamps

	\Procedure{getTS}{\null}	\label{line:rvsimp-getts}
	  \State \Return ++\tots{}
	\EndProcedure

    \Statex \hrulefill
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% For coordinator %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \Statex \textbf{\textit{Coordinator-side data structures and methods:}}
    \Statex The coordinator $\coordinator$ executes the 2PC protocol with masters $\master$ involved in $T$.
    \hStatex

	\Procedure{c-commit}{$T.\attr{writes}, T.\attr{vc}$}	\label{line:rvsimp-ccommit}
	\State split $T.\attr{writes}$ and $\tvc{T}$ with the data partitioning strategy	
	  \label{line:rvsimp-partition}
	  \hStatex

      \lComment{the prepare phase:}
	  \State \algkeyword{rpc-call} \Call{prepare}{$T.\attr{writes}, T.\attr{vc}$} at each $\master$
		\label{line:rvsimp-call-prepare}

      \lComment{the commit phase:}
      \If{all \Call{prepare}{$T.\attr{writes}, T.\attr{vc}$} return \textsl{true}}
		\label{line:rvsimp-prepare-all-true}
	  \State $T.\attr{cts} \gets$ \algkeyword{rpc-call} 
		\Call{getTS}{\null} at $\timeoracle$
		  \label{line:rvsimp-coord-call-getts}
		\State \algkeyword{rpc-call} \Call{commit}{$T.\attr{cts}, T.\attr{writes}$} at each $\master$
		  \label{line:rvsimp-coord-call-commit}
		%   \lComment{early commit notification~\cite{binnig:vldb14}}
        % \State \Return $c$ denoting ``commited''    
      \Else
        \State \algkeyword{rpc-call} \Call{abort}{\null} at each $\master$
		  \label{line:rvsimp-coord-call-abort}
        \State \Return $a$ denoting ``aborted''
      \EndIf

	  \If{all \Call{commit}{$T.\attr{cts}, T.\attr{writes}$} return \textsl{true}}
        \State \Return $c$ denoting ``committed''
	  \Else
		\State \Return $a$ denoting ``aborted''
      \EndIf
    \EndProcedure
    
    \Statex \hrulefill
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% For masters %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \Statex \textbf{\textit{Master-side methods:}}
    \hStatex

    \Procedure{prepare}{$T.\attr{writes}, T.\attr{vc}$} \label{line:rvsimp-prepare}
      \State \Return \Call{check-vc}{$T.\attr{vc}$} \&\& write-conflict freedom
		\label{line:rvsimp-check-in-prepare}
    \EndProcedure

	\Procedure{commit}{$T.\attr{cts}, T.\attr{writes}$}	\label{line:rvsimp-commit}
	  \lComment{apply $T.\attr{writes}$ locally and propagate it} 
		\label{line:rvsimp-apply-in-commit}
    \EndProcedure

	\Procedure{abort}{\null}  \label{line:rvsimp-abort}
	\lComment{abort}
    \EndProcedure
  \end{algorithmic}
\end{algorithm}
